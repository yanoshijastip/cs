<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Chat CS Jastip</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary-color: #007bff; --secondary-color: #f0f2f5; --text-color: #0d0d0d;
            --bubble-sent-bg: var(--primary-color); --bubble-received-bg: #e4e6eb;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        }
        body { font-family: var(--font-family); background-color: #e5e5e5; margin: 0; overflow: hidden; }
        #chat-fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background-color: var(--primary-color); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; cursor: pointer; box-shadow: var(--shadow); transition: transform 0.2s ease-in-out; z-index: 999; }
        #chat-widget { position: fixed; bottom: 100px; right: 30px; width: 370px; height: 70vh; max-height: 600px; background-color: white; border-radius: 15px; box-shadow: var(--shadow); display: flex; flex-direction: column; overflow: hidden; opacity: 0; transform: translateY(20px); pointer-events: none; transition: opacity 0.3s ease, transform 0.3s ease; z-index: 1000; }
        #chat-widget.open { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .widget-header { padding: 20px; background-color: var(--primary-color); color: white; display: flex; align-items: center; position: relative; }
        .admin-info { flex-grow: 1; } .admin-info .name { font-weight: bold; } .admin-info .status { font-size: 0.8em; opacity: 0.9; }
        #close-widget { background: none; border: none; color: rgba(255, 255, 255, 0.7); font-size: 24px; cursor: pointer; transition: color 0.2s ease; padding: 0; line-height: 1; }
        #close-widget:hover { color: #ffffff; }
        .messages-container { flex-grow: 1; padding: 20px; overflow-y: auto; background-color: var(--secondary-color); }
        .message { margin-bottom: 15px; display: flex; flex-direction: column; animation: fadeInUp 0.4s ease forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message .bubble { padding: 12px 18px; border-radius: 20px; max-width: 80%; word-wrap: break-word; }
        .message.sent { align-items: flex-end; } .message.sent .bubble { background-color: var(--bubble-sent-bg); color: white; border-bottom-right-radius: 5px; }
        .message.received { align-items: flex-start; } .message.received .bubble { background-color: var(--bubble-received-bg); color: var(--text-color); border-bottom-left-radius: 5px; }
        .timestamp { font-size: 0.7em; color: #999; margin-top: 4px; } .message.sent .timestamp { text-align: right; }
        .read-receipt { font-size: 0.8em; color: #eee; margin-left: 5px; } .read-receipt.read { color: #4fc3f7; }
        #typing-indicator { padding: 0 20px 10px 20px; display: none; }
        .typing-bubble .dot { display: inline-block; width: 8px; height: 8px; background-color: #999; border-radius: 50%; margin: 0 2px; animation: typing 1.4s infinite; }
        .typing-bubble .dot:nth-child(2) { animation-delay: 0.2s; } .typing-bubble .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-5px); } }
        .widget-footer { padding: 15px 20px; border-top: 1px solid #ddd; }
        .input-area { display: flex; align-items: center; }
        #message-input { flex-grow: 1; border: none; padding: 10px; background-color: transparent; font-size: 1em; }
        #message-input:focus { outline: none; }
        #send-btn { background: none; border: none; color: var(--primary-color); font-size: 20px; cursor: pointer; }
        .hidden { display: none !important; }
        #welcome-popup { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1001; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        #welcome-popup.open { opacity: 1; pointer-events: auto; }
        #popup-content { background: white; padding: 40px; border-radius: 15px; width: 320px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transform: scale(0.9); opacity: 0; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease; position: relative; }
        #welcome-popup.open #popup-content { transform: scale(1); opacity: 1; }
        #popup-content h3 { margin-top: 0; color: var(--primary-color); font-size: 1.8em; margin-bottom: 10px; }
        #popup-content p { color: var(--text-color); font-size: 1em; margin-bottom: 25px; }
        #popup-content input { width: calc(100% - 24px); padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 8px; font-size: 1em; }
        #popup-content button { width: 100%; padding: 12px 20px; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; font-size: 1.1em; cursor: pointer; }
        #end-chat-btn { width: 100%; margin-top: 10px; padding: 8px; background-color: transparent; border: 1px solid #dc3545; color: #dc3545; border-radius: 8px; font-size: 0.9em; cursor: pointer; }
        #close-popup-btn { position: absolute; top: -15px; right: -15px; background-color: white; border: 1px solid #ccc; border-radius: 50%; width: 30px; height: 30px; display: flex; justify-content: center; align-items: center; font-size: 18px; color: #888; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: all 0.2s ease; z-index: 10; }
        #close-popup-btn:hover { background-color: #f0f0f0; color: #333; transform: scale(1.1); }
    </style>
</head>
<body>
    <div id="welcome-popup">
        <div id="popup-content">
            <button id="close-popup-btn" onclick="closePopup()">&times;</button>
            <h3>Halo!</h3>
            <p>Silakan isi data Kamu untuk memulai chat.</p>
            <input type="text" id="guest-name" placeholder="Nama Anda" autocomplete="name">
            <input type="tel" id="guest-wa" placeholder="Nomor WhatsApp (opsional)" autocomplete="tel">
            <button onclick="handleStartChat()">Mulai Chat</button>
        </div>
    </div>
    <div id="chat-fab"><i class="fa-solid fa-comments"></i></div>
    <div id="chat-widget">
        <header class="widget-header">
            <div class="admin-info">
                <div class="name">CS Jastip</div>
                <div class="status" id="admin-status">Online</div>
            </div>
            <button id="close-widget"><i class="fa-solid fa-times"></i></button>
        </header>
        <main class="messages-container" id="widget-messages"></main>
        <div id="typing-indicator">
            <div class="message received"><div class="bubble typing-bubble"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div></div>
        </div>
        <footer class="widget-footer">
            <div class="input-area">
                <input type="text" id="message-input" placeholder="Ketik pesan..." onkeydown="handleEnterKey(event)">
                <button id="send-btn" onclick="sendMessage()"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
            <button id="end-chat-btn" onclick="endChatSession()">Selesaikan Chat</button>
        </footer>
    </div>
    <audio id="notification-sound" src="https://res.cloudinary.com/dhsbixafr/video/upload/v1759203673/new-notification-09-352705_cmjazj.mp3" preload="auto"></audio>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA_2R9DBUUpibY2u6MEenCTDDOZ-w0vlx8",
            authDomain: "aplikasi-chat-d05ce.firebaseapp.com",
            projectId: "aplikasi-chat-d05ce",
            storageBucket: "aplikasi-chat-d05ce.firebasestorage.app",
            messagingSenderId: "115036538813",
            appId: "1:115036538813:web:4113ceb9e5a89c311534d4",
            measurementId: "G-XFNNC4HYM6"
        };
        const ADMIN_UID = "Vjsy4i8HKBaLC1994rmB63IobV02";
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUser = null;
        let unsubscribeChat = null;
        const fab = document.getElementById('chat-fab');
        const widget = document.getElementById('chat-widget');
        const closeBtn = document.getElementById('close-widget');
        const welcomePopup = document.getElementById('welcome-popup');
        
        auth.onAuthStateChanged(user => {
            if (user) { currentUser = { uid: user.uid }; } else { auth.signInAnonymously().catch(console.error); }
        });
        
        fab.addEventListener('click', async () => {
            if (!currentUser) return;
            // FIX: Logika eksplisit untuk memastikan hanya satu yang tampil
            widget.classList.remove('open');
            welcomePopup.classList.remove('open');

            const sessionEnded = localStorage.getItem('chat_session_ended');
            if (sessionEnded === 'true') {
                welcomePopup.classList.add('open');
                return;
            }
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            if (userDoc.exists) {
                widget.classList.add('open');
                listenToChat();
            } else {
                welcomePopup.classList.add('open');
            }
        });

        closeBtn.addEventListener('click', () => {
            widget.classList.remove('open');
            if (unsubscribeChat) { unsubscribeChat(); unsubscribeChat = null; }
        });
        
        welcomePopup.addEventListener('click', (event) => {
            if (event.target === welcomePopup) { closePopup(); }
        });

        function closePopup() { welcomePopup.classList.remove('open'); }

        // ... sisa JavaScript sama persis ...
        async function handleStartChat(){const name=document.getElementById("guest-name").value.trim(),whatsapp=document.getElementById("guest-wa").value.trim();if(name){await db.collection("users").doc(currentUser.uid).set({name:name,whatsapp:whatsapp,uid:currentUser.uid,createdAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:!0}),localStorage.removeItem("chat_session_ended"),closePopup(),widget.classList.add("open"),listenToChat()}else alert("Nama wajib diisi!")}function endChatSession(){if(currentUser){const e=confirm("Apakah Anda yakin ingin mengakhiri percakapan ini? Riwayat chat Anda akan disembunyikan dan Anda perlu mendaftar ulang untuk memulai chat baru.");e&&(localStorage.setItem("chat_session_ended","true"),alert("Percakapan telah diakhiri. Anda akan memulai sesi baru."),location.reload())}}function listenToChat(){if(currentUser&&!unsubscribeChat){let e=new Set;stopAllListeners();const t=document.getElementById("widget-messages");t.innerHTML="",e.clear(),addMessageToUI({text:"Halo! Ada yang bisa kami bantu?",senderId:ADMIN_UID},!1,null,e),db.collection("chats").doc(currentUser.uid).collection("messages").orderBy("timestamp").get().then((o=>{o.forEach((o=>addMessageToUI(o.data(),!1,o.id,e))),t.scrollTop=t.scrollHeight}));let o=null;unsubscribeChat=db.collection("chats").doc(currentUser.uid).onSnapshot((t=>{const s=t.exists?t.data():{};document.getElementById("typing-indicator").style.display=s.adminIsTyping?"block":"none";const a=s.lastReadByAdmin?s.lastReadByAdmin.toMillis():0;document.querySelectorAll(".read-receipt").forEach((e=>{const t=parseInt(e.getAttribute("data-timestamp"));t<=a&&(e.innerHTML='<i class="fa-solid fa-check-double"></i>',e.classList.add("read"))})),o&&o(),o=db.collection("chats").doc(currentUser.uid).collection("messages").where("timestamp",">",new Date).onSnapshot((t=>{t.docChanges().forEach((t=>{"added"===t.type&&addMessageToUI(t.doc.data(),!0,t.doc.id,e)}))}))}))}}async function sendMessage(){const e=document.getElementById("message-input"),t=e.value.trim();if(""!==t&&currentUser){e.value="";const o={text:t,senderId:currentUser.uid,timestamp:firebase.firestore.FieldValue.serverTimestamp()};await db.collection("chats").doc(currentUser.uid).collection("messages").add(o),await db.collection("users").doc(currentUser.uid).set({lastUpdate:firebase.firestore.FieldValue.serverTimestamp()},{merge:!0}),await db.collection("chats").doc(currentUser.uid).set({lastUpdate:firebase.firestore.FieldValue.serverTimestamp(),adminUnreadCount:firebase.firestore.FieldValue.increment(1)},{merge:!0})}}function addMessageToUI(e,t=!1,o,s){if(o&&s.has(o))return;o&&s.add(o);const a=e.senderId===currentUser.uid,n=document.getElementById("widget-messages"),d=document.createElement("div");d.classList.add("message",a?"sent":"received");const i=e.timestamp?e.timestamp.toDate().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"",c=e.timestamp?e.timestamp.toMillis():0;d.innerHTML=`<div class="bubble">${e.text}</div><div class="timestamp">${i}${a?`<span class="read-receipt" data-timestamp="${c}"><i class="fa-solid fa-check"></i></span>`:""}</div>`,t&&!a&&document.getElementById("chat-widget").classList.contains("open")&&document.getElementById("notification-sound").play().catch((e=>{})),n.appendChild(d),(t||n.scrollHeight<=n.clientHeight+150)&&(n.scrollTop=n.scrollHeight)}function handleEnterKey(e){"Enter"===e.key&&sendMessage()}function stopAllListeners(){unsubscribeChat&&(unsubscribeChat(),unsubscribeChat=null)}
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Chat CS Jastip</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f4; }
        .container { max-width: 400px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        input { width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button { width: 100%; padding: 10px; background-color: #007BFF; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .hidden { display: none !important; }
        #welcome-popup { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        #popup-content { background: white; padding: 30px; border-radius: 8px; width: 300px; text-align: center; }
        .messages { height: 300px; border: 1px solid #ddd; overflow-y: scroll; padding: 10px; margin-bottom: 10px; }
        .message { margin-bottom: 10px; max-width: 70%; }
        .message span { display: inline-block; background: #007BFF; color: white; padding: 8px 12px; border-radius: 15px; }
        .message.sent { margin-left: auto; text-align: right; }
        .message.received { margin-right: auto; text-align: left; }
        .message.received span { background: #e9e9eb; color: black; }
    </style>
</head>
<body>

<div class="container">
    <div id="welcome-popup" class="hidden">
        <div id="popup-content">
            <h3>Selamat Datang!</h3>
            <p>Isi data Anda untuk memulai chat.</p>
            <input type="text" id="guest-name" placeholder="Nama Anda">
            <input type="text" id="guest-wa" placeholder="Nomor WhatsApp (opsional)">
            <button onclick="handleStartChat()">Mulai Chat</button>
        </div>
    </div>

    <div id="user-chat-view" class="hidden">
        <h2 id="chat-title">Chat dengan CS Jastip</h2>
        <div class="messages" id="user-messages"></div>
        <input type="text" id="user-message-input" placeholder="Ketik pesan Anda...">
        <button onclick="sendMessageAsUser()">Kirim</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
    // ===== PENTING: GUNAKAN KONFIGURASI FIREBASE YANG SAMA =====
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyA_2R9DBUUpibY2u6MEenCTDDOZ-w0vlx8",
      authDomain: "aplikasi-chat-d05ce.firebaseapp.com",
      projectId: "aplikasi-chat-d05ce",
      storageBucket: "aplikasi-chat-d05ce.firebasestorage.app",
      messagingSenderId: "115036538813",
      appId: "1:115036538813:web:4113ceb9e5a89c311534d4",
      measurementId: "G-XFNNC4HYM6"
    };
    
    // ===== UID ADMIN TETAP DIBUTUHKAN UNTUK MENGIRIM PESAN =====
    const ADMIN_UID = "Vjsy4i8HKBaLC1994rmB63IobV02"; 

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let unsubscribeMessages = null;

    const welcomePopup = document.getElementById('welcome-popup');
    const userChatView = document.getElementById('user-chat-view');

    auth.onAuthStateChanged(async user => {
        if (user) {
            currentUser = { uid: user.uid };
            const userDoc = await db.collection('users').doc(user.uid).get();
            if (userDoc.exists) {
                document.getElementById('chat-title').textContent = `Chat sebagai ${userDoc.data().name}`;
                showUserChat();
            } else {
                welcomePopup.classList.remove('hidden');
            }
        } else {
            auth.signInAnonymously().catch(error => console.error(error));
        }
    });

    async function handleStartChat() {
        const name = document.getElementById('guest-name').value.trim();
        const whatsapp = document.getElementById('guest-wa').value.trim();
        if (!name) return alert("Nama wajib diisi!");
        
        await db.collection('users').doc(currentUser.uid).set({ name, whatsapp, uid: currentUser.uid });
        document.getElementById('chat-title').textContent = `Chat sebagai ${name}`;
        showUserChat();
    }
    
    function showUserChat() {
        loadMessagesForUser();
        welcomePopup.classList.add('hidden');
        userChatView.classList.remove('hidden');
    }

    function loadMessagesForUser() { /* ... fungsi sama persis seperti sebelumnya ... */ }
    async function sendMessageAsUser() { /* ... fungsi sama persis seperti sebelumnya ... */ }
    function createMessageElement(text, isSent) { /* ... fungsi sama persis seperti sebelumnya ... */ }
    
    // --- Salin fungsi-fungsi di bawah ini dari kode sebelumnya ---
    function loadMessagesForUser() {
        const messagesDiv = document.getElementById('user-messages');
        const chatId = currentUser.uid;
        if (unsubscribeMessages) unsubscribeMessages();
        unsubscribeMessages = db.collection('chats').doc(chatId).collection('messages').orderBy('timestamp')
            .onSnapshot(snapshot => {
                messagesDiv.innerHTML = '';
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const el = createMessageElement(msg.text, msg.senderId === currentUser.uid);
                    messagesDiv.appendChild(el);
                });
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            });
    }

    async function sendMessageAsUser() {
        const input = document.getElementById('user-message-input');
        const text = input.value.trim();
        if (text === '') return;
        const chatId = currentUser.uid;
        const message = { text, senderId: currentUser.uid, receiverId: ADMIN_UID, timestamp: firebase.firestore.FieldValue.serverTimestamp() };
        await db.collection('chats').doc(chatId).collection('messages').add(message);
        await db.collection('chats').doc(chatId).set({ lastUpdate: firebase.firestore.FieldValue.serverTimestamp(), userHasUnread: true }, { merge: true });
        input.value = '';
    }

    function createMessageElement(text, isSent) {
        const el = document.createElement('div');
        el.classList.add('message', isSent ? 'sent' : 'received');
        el.innerHTML = `<span>${text}</span>`;
        return el;
    }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Chat CS Yanoshi Jastip</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f4; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        input { width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button { width: 100%; padding: 10px; background-color: #007BFF; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        h2, h3 { text-align: center; }
        .hidden { display: none !important; }

        /* Popup Styles */
        #welcome-popup { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        #popup-content { background: white; padding: 30px; border-radius: 8px; width: 300px; text-align: center; }

        /* General Chat Styles */
        .messages { height: 300px; border: 1px solid #ddd; overflow-y: scroll; padding: 10px; margin-bottom: 10px; }
        .message { margin-bottom: 10px; max-width: 70%; }
        .message span { display: inline-block; background: #007BFF; color: white; padding: 8px 12px; border-radius: 15px; }
        .message.sent { margin-left: auto; text-align: right; }
        .message.received { margin-right: auto; text-align: left; }
        .message.received span { background: #e9e9eb; color: black; }
        #logout-btn { background-color: #dc3545; margin-top: 20px; position:absolute; top:20px; right:20px; width: auto; padding: 5px 10px;}

        /* Admin Dashboard Styles */
        #admin-dashboard-view { display: flex; gap: 20px; }
        #admin-user-list { flex: 1; border-right: 1px solid #ddd; padding-right: 20px; }
        #admin-user-list ul { list-style: none; padding: 0; }
        #admin-user-list li { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        #admin-user-list li:hover, #admin-user-list li.active { background-color: #f0f0f0; }
        #admin-chat-window { flex: 2; }
    </style>
</head>
<body>

<div class="container">

    <div id="welcome-popup" class="hidden">
        <div id="popup-content">
            <h3>Selamat Datang!</h3>
            <p>Silakan isi data Anda untuk memulai chat.</p>
            <input type="text" id="guest-name" placeholder="Nama Anda">
            <input type="tel" id="guest-wa" placeholder="Nomor WhatsApp (opsional)">
            <button onclick="handleStartChat()">Mulai Chat</button>
        </div>
    </div>
    
    <div id="admin-login-view">
        <h2>Admin Login</h2>
        <input type="email" id="admin-email" placeholder="Email Admin">
        <input type="password" id="admin-password" placeholder="Password Admin">
        <button onclick="handleAdminLogin()">Login sebagai Admin</button>
    </div>

    <div id="user-chat-view" class="hidden">
        <h2 id="chat-title">Chat dengan Customer Service</h2>
        <div class="messages" id="user-messages"></div>
        <input type="text" id="user-message-input" placeholder="Ketik pesan Anda...">
        <button onclick="sendMessageAsUser()">Kirim</button>
    </div>
    
    <div id="admin-dashboard-view" class="hidden">
        <div id="admin-user-list">
            <h3>Daftar Percakapan</h3>
            <ul id="conversations-list"></ul>
        </div>
        <div id="admin-chat-window">
            <h3 id="admin-chat-header">Pilih percakapan</h3>
            <div class="messages" id="admin-messages"></div>
            <div id="admin-chat-form" class="hidden">
                <input type="text" id="admin-message-input" placeholder="Ketik balasan...">
                <button onclick="sendMessageAsAdmin()">Kirim Balasan</button>
            </div>
        </div>
        <button id="logout-btn" onclick="handleLogout()">Logout</button>
    </div>

</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
    // =================================================================
    // ===== PASTE KONFIGURASI FIREBASE ANDA DI SINI! ====
    // =================================================================
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyA_2R9DBUUpibY2u6MEenCTDDOZ-w0vlx8",
      authDomain: "aplikasi-chat-d05ce.firebaseapp.com",
      projectId: "aplikasi-chat-d05ce",
      storageBucket: "aplikasi-chat-d05ce.firebasestorage.app",
      messagingSenderId: "115036538813",
      appId: "1:115036538813:web:4113ceb9e5a89c311534d4",
      measurementId: "G-XFNNC4HYM6"
    };
    
    // =================================================================
    // ===== !!! GANTI DENGAN UID ADMIN ANDA !!!  =====
    // =================================================================
    const ADMIN_UID = "Vjsy4i8HKBaLC1994rmB63IobV02"; 

    // Inisialisasi Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Global variables
    let currentUser = null;
    let selectedConversationId = null;
    let unsubscribeMessages = null;

    // DOM Elements
    const adminLoginView = document.getElementById('admin-login-view');
    const welcomePopup = document.getElementById('welcome-popup');
    const userChatView = document.getElementById('user-chat-view');
    const adminDashboardView = document.getElementById('admin-dashboard-view');
    
    // ==============================================================
    // ===== LOGIKA UTAMA: MENGATUR SESI PENGGUNA =====
    // ==============================================================
    auth.onAuthStateChanged(async user => {
        if (user) {
            currentUser = { uid: user.uid, isAnonymous: user.isAnonymous };
            
            // Cek jika ini adalah Admin
            if (user.uid === ADMIN_UID) {
                showAdminDashboard();
            } else if (user.isAnonymous) {
                // Cek jika pengguna anonim ini sudah pernah submit data
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists) {
                    // Jika sudah, langsung tampilkan chat
                    document.getElementById('chat-title').textContent = `Chat sebagai ${userDoc.data().name}`;
                    showUserChat();
                } else {
                    // Jika belum, tampilkan popup
                    showWelcomePopup();
                }
            }
        } else {
            // Jika tidak ada user sama sekali, tampilkan login admin atau mulai sesi anonim
            adminLoginView.classList.remove('hidden');
            // Coba login anonim untuk pengunjung baru
            auth.signInAnonymously().catch(error => console.error("Anonymous Sign-In Error:", error));
        }
    });

    // ==============================================================
    // ===== FUNGSI UNTUK ALUR PENGGUNA BARU (ANONIM) =====
    // ==============================================================
    async function handleStartChat() {
        const name = document.getElementById('guest-name').value.trim();
        const whatsapp = document.getElementById('guest-wa').value.trim();

        if (!name) {
            return alert("Nama wajib diisi!");
        }

        // Simpan data pengguna anonim ke Firestore
        await db.collection('users').doc(currentUser.uid).set({
            name: name,
            whatsapp: whatsapp,
            uid: currentUser.uid
        });

        document.getElementById('chat-title').textContent = `Chat sebagai ${name}`;
        showUserChat(); // Tampilkan jendela chat setelah submit
    }

    // ==============================================================
    // ===== FUNGSI UNTUK LOGIN ADMIN & LOGOUT =====
    // ==============================================================
    async function handleAdminLogin() {
        const email = document.getElementById('admin-email').value;
        const password = document.getElementById('admin-password').value;
        try {
            await auth.signInWithEmailAndPassword(email, password);
        } catch (error) {
            alert("Login Admin Gagal: " + error.message);
        }
    }

    function handleLogout() {
        if (unsubscribeMessages) unsubscribeMessages();
        const isAdmin = currentUser.uid === ADMIN_UID;
        auth.signOut().then(() => {
            // Setelah admin logout, kita relogin sbg anonim agar halaman tidak kosong
            if (isAdmin) {
                 window.location.reload();
            }
        });
    }
    
    // ==============================================================
    // ===== FUNGSI-FUNGSI BANTUAN UI =====
    // ==============================================================
    function showWelcomePopup() {
        welcomePopup.classList.remove('hidden');
        adminLoginView.classList.add('hidden');
        userChatView.classList.add('hidden');
        adminDashboardView.classList.add('hidden');
    }

    function showUserChat() {
        loadMessagesForUser();
        welcomePopup.classList.add('hidden');
        adminLoginView.classList.add('hidden');
        userChatView.classList.remove('hidden');
        adminDashboardView.classList.add('hidden');
    }
    
    function showAdminDashboard() {
        loadUserConversations();
        welcomePopup.classList.add('hidden');
        adminLoginView.classList.add('hidden');
        userChatView.classList.add('hidden');
        adminDashboardView.classList.remove('hidden');
    }
    
    // ==============================================================
    // ===== KODE CHAT (SEBAGIAN BESAR SAMA SEPERTI SEBELUMNYA) =====
    // ==============================================================
    
    // KODE UNTUK USER
    function loadMessagesForUser() {
        const messagesDiv = document.getElementById('user-messages');
        const chatId = currentUser.uid;
        if (unsubscribeMessages) unsubscribeMessages();
        unsubscribeMessages = db.collection('chats').doc(chatId).collection('messages').orderBy('timestamp')
            .onSnapshot(snapshot => {
                messagesDiv.innerHTML = '';
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const el = createMessageElement(msg.text, msg.senderId === currentUser.uid);
                    messagesDiv.appendChild(el);
                });
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            });
    }

    async function sendMessageAsUser() {
        const input = document.getElementById('user-message-input');
        const text = input.value.trim();
        if (text === '') return;
        const chatId = currentUser.uid;
        const message = { text, senderId: currentUser.uid, receiverId: ADMIN_UID, timestamp: firebase.firestore.FieldValue.serverTimestamp() };
        await db.collection('chats').doc(chatId).collection('messages').add(message);
        await db.collection('chats').doc(chatId).set({ lastUpdate: firebase.firestore.FieldValue.serverTimestamp(), userHasUnread: true }, { merge: true });
        input.value = '';
    }

    // KODE UNTUK ADMIN
    async function loadUserConversations() {
        const listUl = document.getElementById('conversations-list');
        db.collection('chats').orderBy('lastUpdate', 'desc').onSnapshot(async snapshot => {
            listUl.innerHTML = '';
            for (const chatDoc of snapshot.docs) {
                const userId = chatDoc.id;
                const userDoc = await db.collection('users').doc(userId).get();
                const userName = userDoc.exists ? userDoc.data().name : 'Guest';
                const userWA = userDoc.exists ? userDoc.data().whatsapp : '';

                const li = document.createElement('li');
                li.innerHTML = `${userName} <br><small>${userWA}</small>`;
                li.setAttribute('data-uid', userId);
                li.onclick = () => selectConversationForAdmin(userId, userName);
                if (chatDoc.data().userHasUnread) li.style.fontWeight = 'bold';
                listUl.appendChild(li);
            }
        });
    }
    
    async function selectConversationForAdmin(userId, userName) {
        selectedConversationId = userId;
        document.getElementById('admin-chat-header').textContent = `Balas pesan dari ${userName}`;
        document.getElementById('admin-chat-form').classList.remove('hidden');
        document.querySelectorAll('#conversations-list li').forEach(li => {
            li.classList.remove('active');
            if (li.getAttribute('data-uid') === userId) li.classList.add('active');
        });
        await db.collection('chats').doc(userId).set({ userHasUnread: false }, { merge: true });
        loadMessagesForAdmin(userId);
    }
    
    function loadMessagesForAdmin(userId) { /* ... (fungsi ini tidak berubah) ... */ }
    async function sendMessageAsAdmin() { /* ... (fungsi ini tidak berubah) ... */ }
    function createMessageElement(text, isSent) { /* ... (fungsi ini tidak berubah) ... */ }
    
    // Salin fungsi loadMessagesForAdmin, sendMessageAsAdmin, dan createMessageElement
    // dari kode di jawaban sebelumnya, karena mereka tidak berubah.
    // (Saya sertakan lagi di bawah untuk kelengkapan)

    function loadMessagesForAdmin(userId) {
        const messagesDiv = document.getElementById('admin-messages');
        if (unsubscribeMessages) unsubscribeMessages();
        unsubscribeMessages = db.collection('chats').doc(userId).collection('messages').orderBy('timestamp')
            .onSnapshot(snapshot => {
                messagesDiv.innerHTML = '';
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const el = createMessageElement(msg.text, msg.senderId === ADMIN_UID);
                    messagesDiv.appendChild(el);
                });
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            });
    }

    async function sendMessageAsAdmin() {
        const input = document.getElementById('admin-message-input');
        const text = input.value.trim();
        if (text === '' || !selectedConversationId) return;
        const message = { text, senderId: ADMIN_UID, receiverId: selectedConversationId, timestamp: firebase.firestore.FieldValue.serverTimestamp() };
        await db.collection('chats').doc(selectedConversationId).collection('messages').add(message);
        await db.collection('chats').doc(selectedConversationId).set({ lastUpdate: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
        input.value = '';
    }

    function createMessageElement(text, isSent) {
        const el = document.createElement('div');
        el.classList.add('message', isSent ? 'sent' : 'received');
        el.innerHTML = `<span>${text}</span>`;
        return el;
    }

</script>
</body>
</html>
